# Issues with aspect_rules_ts

This repository demonstrates issues with `aspect_rules_ts` when using it with
Bazel modules.

## module_a

The module in `module_a` is the base module that works correctly in isolation.
You might imagine this a module published to a Bazel module registry. It exposes
a a single `//:content` target, which is a `ts_project`.

You can verify that this module works in isolation.

```console
cd module_a
bazel build //:content
```

## module_b

The module in `module_b` depends on `module_a` and attempts to use its
`//:content` target as an input to its `//:consumer` target.

This module demonstrates that issue that the `aspect_rules_ts` repository rule
cannot be executed with the same name by two completely independent modules.
The repository rule is invoked with `rules_ts_ext.deps`.

You can reproduce the error by build the consumer target:

```console
cd module_b
bazel build //:consumer
```

This will give you an error like this:

> Error in repository_rule: A repo named npm_typescript is already generated by this module extension at ...

This behavior is not well documented and is confusing. As dependent of a module,
I expect that the tooling it uses does not influence or restrict what tooling
I can use. It's particularly annoying because `rules_ts_ext.deps` has a default
name and the `ts_project` rule implicitly depends on this name through its
defaults (for `tsc`, `tsc_worker` and `validator`). While changing the name
of the repository is possible by setting `name` on `rules_ts_ext.deps`, this
requires _all_ usages of `ts_project` to manually specify the aforementioned
attributes with the new repository name.

## module_c

Modules that do not use `aspect_rules_ts` cannot depend on targets from modules
that use `aspect_rules_ts`. This is because any invocation of rules from there
(such as `ts_project`) requires module scoped build flags. You can see these
flags in the `.bazelrc` of `module_a` and `module_b`. Builds without these
flags will fail, including in dependencies.

```console
cd module_c
bazel build //:module_a_content_tar
```

This will generate an error:

> ######## Required Typecheck Performance Selection ########
>
> TypeScript's type-checking exposes a flag `--skipLibCheck`:
> https://www.typescriptlang.org/tsconfig#skipLibCheck
> ...

The module in `module_c` cannot fix this if it does not depend on
`aspect_rules_ts` itself, even if it doesn't need it for its own builds. This
is because the required flags require the module to be available.

You can verify this by uncommenting the lines starting with `common ...` in
`module_c/.bazelrc` and running the build again. This will result in:

> ERROR: @aspect_rules_ts//ts:skipLibCheck :: Error loading option @aspect_rules_ts//ts:skipLibCheck: No repository visible as '@aspect_rules_ts' from main repository. ...
